

isbn_list = [	9782260029205,  9781847247940,	9781849049979,	9781860467226,	9782020348966,	9782020368049,	9782070302390,	9782264045812,	9782266245487,	9782266254298,	9782266272926,	9782267019551,	9782296047334,	9782296052512,	9782330103996,	9782343024608,	9782343140858,	9782367320670,	9782367320694,	9782367320779,	9782367320823,	9782367320861,	9782367320861,	9782367321127,	9782367321127,	9782367321165,	9782367321165,	9782367321165,	9782367321165,	9782367321165,	9782367321165,	9782367321226,	9782367321233,	9782367321233,	9782367321257,	9782367321257,	9782367321257,	9782367321257,	9782367321257,	9782367321257,	9782367321257,	9782367321257,	9782367321271,	9782367321295,	9782367321295,	9782367321301,	9782367321332,	9782367321363,	9782367321363,	9782367321400,	9782367321400,	9782367321400,	9782367321431,	9782367321462,	9782367321530,	9782367321561,	9782367321608,	9782367321608,	9782367321608,	9782367321608,	9782367321653,	9782367321707,	9782367321707,	9782367321707,	9782367321707,	9782367321707,	9782367321738,	9782367321752,	9782367321752,	9782367321752,	9782367321844,	9782367321844,	9782367321882,	9782367321882,	9782367321882,	9782367321882,	9782367321882,	9782367321882,	9782367321882,	9782367821951,	9782729116484,	9782738116666,	9782743639341,	9782757810330,	9782757845486,	9782847431063,	9782847431407,	9782847432091,	9782864246640,	9782868696250,	9782906462144,	9782906462168,	9782906462236,	9782906462335,	9782906462342,	9782906462359,	9782915540024,	9782915540178,	9782915540185,	9782915540185,	9782915540192,	9782915540277,	9782915540352,	9782915540352,	9782915540512,	9782915540765,	9782915540772,	9782915540826,	9782915540833,	9782915540864,	9782915540864,	9782915540864,	9782915540864,	9782953270778,	9782960212501,	9783943254075,	9783946277118,	9783946277118,	9783946277118,	9783946277118,	9783946277118,	9783946277156,	9783946277200,	9788416510672,	9788501039972,	9788501076076,	9788501079428,	9788501111692,	9788501111708,	9788563179036,	9788563179043,	9788563739087,	9788579395451,	9788586399480,	9788591203215,	9789029539579,	9789029564496,	9789029567671,	9789082757774,	9789082757774,	9789492313058,	9789492313515,	9789492313515,	9789492313515,	9789492313515,	9789492313515,	9789492313515,	9789492313515,	9789492313515,	9789492313515,	9789720030306,	9789720030351,	9789720030405,	9789720030412,	9789720030436,	9789720030443,	9789720030481,	9789720030535,	9789720030542,	9789720030542,	9789720030825,	9789720030986,	9789720031280,	9789720031341,	9789720031372,	9789720031396,	9789720031488,	9789720031488,	9789720031693,	9789720031693,	9789720032539,	9789720040985,	9789720046000,	9789720046338,	9789720046482,	9789720046499,	9789720046499,	9789720046499,	9789720046499,	9789720046499,	9789720046499,	9789720046499,	9789720046512,	9789720046536,	9789720046536,	9789720046536,	9789720046543,	9789720046673,	9789720046673,	9789720046710,	9789720046710,	9789720046819,	9789720046826,	9789720046826,	9789720046833,	9789720046857,	9789720046895,	9789720047205,	9789720047472,	9789720047595,	9789720047595,	9789720048554,	9789720048554,	9789720048820,	9789720049513,	9789720049520,	9789720049551,	9789720049568,	9789720049568,	9789720049575,	9789720049575,	9789720049605,	9789720049612,	9789720049636,	9789720049636,	9789720049636,	9789720049650,	9789720049674,	9789720049681,	9789720049728,	9789720049759,	9789720049766,	9789720049773,	9789720049858,	9789720063397,	9789720301604,	9789720301604,	9789720301604,	9789720726278,	9789720726582,	9789720726667,	9789720793102,	9789720793102,	9789722028981,	9789722030113,	9789722032452,	9789722035484,	9789722036320,	9789722036856,	9789722044080,	9789722046886,	9789722049719,	9789722050364,	9789722050364,	9789722052061,	9789722052061,	9789722052252,	9789722052474,	9789722052894,	9789722053280,	9789722054409,	9789722056991,	9789722059633,	9789722060226,	9789722060417,	9789722061285,	9789722062459,	9789722063081,	9789722063548,	9789722063579,	9789722064569,	9789722064583,	9789722064668,	9789722064835,	9789722065047,	9789722065269,	9789722065344,	9789722065344,	9789722065566,	9789722065764,	9789722065764,	9789722065788,	9789722065825,	9789722065993,	9789722066075,	9789722066464,	9789722066617,	9789722066730,	9789722067805,	9789722068109,	9789722068109,	9789722068192,	9789722068420,	9789722068499,	9789722120814,	9789722121309,	9789722123990,	9789722124584,	9789722126748,	9789722126922,	9789722127042,	9789722128193,	9789722128667,	9789722128728,	9789722128803,	9789722129107,	9789722129169,	9789722129374,	9789722129503,	9789722129558,	9789722129671,	9789722129688,	9789722129718,	9789722129961,	9789722130035,	9789722130035,	9789722130080,	9789722130196,	9789722230896,	9789722353212,	9789722359580,	9789722360890,	9789722362719,	9789722522861,	9789722526289,	9789722526609,	9789722528009,	9789722530996,	9789722533867,	9789722534673,	9789722534925,	9789722535335,	9789722536769,	9789722536875,	9789722536974,	9789722536974,	9789722537452,	9789722537506,	9789722537506,	9789722537629,	9789722537711,	9789722636070,	9789722636223,	9789722718547,	9789722724517,	9789723616620,	9789723705898,	9789723706444,	9789723706529,	9789723706840,	9789723706888,	9789723711219,	9789723711264,	9789723711608,	9789723712001,	9789723713794,	9789723714173,	9789723716160,	9789723716665,	9789723716924,	9789723716924,	9789723716931,	9789723717013,	9789723717013,	9789723717051,	9789723717051,	9789723717464,	9789723717464,	9789723717877,	9789723717907,	9789723718249,	9789723718546,	9789723718553,	9789723719413,	9789723719598,	9789723719611,	9789723719918,	9789723720136,	9789723720198,	9789723720693,	9789723829174,	9789723829174,	9789723829174,	9789723829174,	9789723829174,	9789723829174,	9789723829174,	9789723829662,	9789723830064,	9789723830590,	9789724047300,	9789724079158,	9789724621951,	9789724751573,	9789725304181,	9789725593998,	9789725647400,	9789725647417,	9789725685501,	9789725686263,	9789725686737,	9789725686737,	9789726629948,	9789726713814,	9789726714682,	9789727081592,	9789727082438,	9789727085170,	9789727086238,	9789727087921,	9789727088119,	9789727088430,	9789727806492,	9789727952564,	9789727952588,	9789727952632,	9789727953530,	9789727953530,	9789727953554,	9789728758493,	9789729792864,	9789892041933,	9789892043555,	9789892069692,	9789892090245,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892095011,	9789892336640,	9789892338385,	9789892338408,	9789892340494,	9789892345567,	9789892800233,	9789895186761,	9789895230365,	9789895400201,	9789895425631,	9789895448609,	9789895551132,	9789895558322,	9789896150860,	9789896151041,	9789896152116,	9789896152147,	9789896152154,	9789896152215,	9789896152222,	9789896152239,	9789896152277,	9789896167509,	9789896167837,	9789896168070,	9789896168469,	9789896168469,	9789896168469,	9789896229368,	9789896229986,	9789896231835,	9789896231965,	9789896232269,	9789896232702,	9789896232719,	9789896263669,	9789896265038,	9789896266271,	9789896267940,	9789896268114,	9789896268558,	9789896268671,	9789896268695,	9789896268701,	9789896268725,	9789896268756,	9789896268800,	9789896410148,	9789896411954,	9789896412982,	9789896412982,	9789896413729,	9789896413743,	9789896414238,	9789896414276,	9789896415006,	9789896415280,	9789896415297,	9789896415303,	9789896415310,	9789896415426,	9789896415945,	9789896416393,	9789896417062,	9789896417123,	9789896417352,	9789896417475,	9789896417475,	9789896417727,	9789896417925,	9789896417949,	9789896417970,	9789896418113,	9789896418311,	9789896418311,	9789896418519,	9789896418540,	9789896418564,	9789896418694,	9789896418694,	9789896418748,	9789896418762,	9789896418823,	9789896418939,	9789896418939,	9789896418960,	9789896418984,	9789896418984,	9789896419035,	9789896419066,	9789896419097,	9789896419141,	9789896419219,	9789896419301,	9789896419370,	9789896419462,	9789896419677,	9789896443344,	9789896445003,	9789896445270,	9789896445430,	9789896445539,	9789896445874,	9789896446000,	9789896584054,	9789896584351,	9789896585365,	9789896600617,	9789896602055,	9789896602253,	9789896605513,	9789896605773,	9789896605872,	9789896605872,	9789896652791,	9789896653071,	9789896653620,	9789896654986,	9789896655297,	9789896655297,	9789896655754,	9789896655785,	9789896655877,	9789896655877,	9789896655914,	9789896656928,	9789896657314,	9789896657604,	9789896657604,	9789896657635,	9789896657727,	9789896658038,	9789896658458,	9789896658465,	9789896658465,	9789896659080,	9789896659127,	9789896661946,	9789896681869,	9789896711252,	9789896712877,	9789896713188,	9789896713270,	9789896713270,	9789896713652,	9789896714154,	9789896714185,	9789896714192,	9789896714208,	9789896714215,	9789896714253,	9789896714383,	9789896714420,	9789896714758,	9789896714802,	9789896714857,	9789896714901,	9789896714963,	9789896714987,	9789896715014,	9789896715052,	9789896715069,	9789896715076,	9789896715168,	9789896715250,	9789896875053,	9789896896591,	9789896920654,	9789896920654,	9789896920944,	9789896920944,	9789896921217,	9789896921217,	9789896921347,	9789897023255,	9789897023286,	9789897023675,	9789897024009,	9789897024207,	9789897024214,	9789897024221,	9789897024245,	9789897024283,	9789897025020,	9789897025105,	9789897074653,	9789897077364,	9789897103421,	9789897110108,	9789897221026,	9789897221262,	9789897221798,	9789897222658,	9789897222658,	9789897222658,	9789897222788,	9789897223273,	9789897223402,	9789897223563,	9789897223686,	9789897223976,	9789897224393,	9789897224416,	9789897224416,	9789897224423,	9789897224423,	9789897224430,	9789897224591,	9789897224591,	9789897224737,	9789897225154,	9789897225154,	9789897225352,	9789897225369,	9789897225796,	9789897225826,	9789897225857,	9789897226212,	9789897226212,	9789897241932,	9789897241970,	9789897242076,	9789897242816,	9789897244049,	9789897244056,	9789897244179,	9789897244254,	9789897244421,	9789897244513,	9789897244575,	9789897311550,	9789897360695,	9789897411786,	9789897412585,	9789897414442,	9789897414886,	9789897416361,	9789897417214,	9789897418976,	9789897430961,	9789897523885,	9789897541698,	9789897543333,	9789897543456,	9789897543500,	9789897543975,	9789897650291,	9789897660924,	9789897661099,	9789897661334,	9789897661778,	9789897684944,	9789897731181,	9789897731181,	9789897761010,	9789897761010,	9789897761010,	9789897771859,	9789897772689,	9789897800023,	9789897800047,	9789897800085,	9789898093011,	9789898217417,	9789898217448,	9789898219558,	9789898256478,	9789898256713,	9789898256843,	9789898307286,	9789898307330,	9789898342195,	9789898342669,	9789898352385,	9789898452283,	9789898470263,	9789898470263,	9789898541284,	9789898572479,	9789898580429,	9789898729590,	9789898760555,	9789898761408,	9789898775290,	9789898776051,	9789898776570,	9789898784612,	9789898789129,	9789898789129,	9789898789198,	9789898789426,	9789898818188,	9789898818607,	9789898818867,	9789898828248,	9789898828262,	9789898828460,	9789898828460,	9789898828491,	9789898828910,	9789898834928,	9789898834959,	9789898858214,	9789898858443,	9789898866530,	9789898871244,	9789898871251,	9789898871473,	9789898872036,	9789898872098,	9789898872197,	9789898886514,	9789898888235,	9789898902481,	9789898907622,	9789898907622,	9789898907622,	9789898907622,	9789898911490,	9789898911490,	9789898911490,	9789898938237,	9789898975270,	9789898979056,	9789898979056,	9789898979056,	9789898979056,	9789898979056,	9789898979261,	9789898979261,	9789899568792,	9789899846241,	9789899919617,	9789899926479,	9789899945418,	9789899956384,	9789899972056,	9789899972193,	9789899974678,	9789899978980,	9789899980037,	9789899980075,	9789899980099,	9789899990593,	9791091837170,	9791091837170,	9791091837170,	9799725592747,5601072406254,	5601072496293,	9781447299844,	9781521470879,	9781717984692,	9781781258644,	9781784871789,	9781784871796,	9781784871796,
]


from selenium.webdriver.common.keys import Keys
from django.db import IntegrityError
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from bs4 import BeautifulSoup
from datetime import datetime, timedelta
import locale
import re, json
import time
import os
import pandas as pd
import psycopg2
import logging
from django.template.defaultfilters import slugify
from selenium.common.exceptions import (
    NoSuchElementException,
    WebDriverException,
    ElementNotVisibleException,
)


def create_connection_postgres():
    try:
        if os.environ.get('DJANGO_DEVELOPMENT') is not None:
            connection = psycopg2.connect(user=os.environ.get('dbuser'),
                                          password=os.environ.get(
                                              'dbpassword'),
                                          host=os.environ.get('hostipdev'),
                                          port=os.environ.get('pnumber'),
                                          database='ecom')
        else:
            connection = psycopg2.connect(user=os.environ.get('dbuser'),
                                          password=os.environ.get(
                                              'dbpassword'),
                                          host=os.environ.get('hostip'),
                                          port=os.environ.get('pnumber'),
                                          database='ecom')
        cursor = connection.cursor()

    except (Exception, psycopg2.Error) as error:
        print("Error while connecting to PostgreSQL", error)
    return cursor, connection


def make_webdriver():
    options = Options()
    # options.add_argument('--headless')
    options.add_argument('--disable-gpu')
    options.add_argument('--no-sandbox')
    options.add_argument("user-agent=[User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:74.0) Gecko/20100101 Firefox/74.0]")
    driver = webdriver.Chrome('/usr/bin/chromedriver', chrome_options=options)
    return driver

   
def grab_from_amazon(url, isbn, driver):
    search_query = 'site:amazon.com.br/ AND ' + str(isbn)
    driver.get(url)
    try:
        search_query = driver.find_element_by_name('q').send_keys(search_query)
    except NoSuchElementException:
        pass
    time.sleep(0.5)
    try:
        driver.find_element_by_name('q').send_keys(Keys.RETURN)
    except NoSuchElementException:
        pass
    time.sleep(3)
    soup = BeautifulSoup(driver.page_source, features="html.parser")
    try:
        cites = driver.find_elements_by_tag_name('cite')
    except NoSuchElementException:
        pass
    output = ''
    for cite in cites:
        if len(cite.text)>0:
           index = cite.text.find("› ")
           output = cite.text[index+2:]
           break
    url = ''
    for a in soup.find_all('a'):
        if 'href' in a.attrs:
            if output[:output.find('...')] in a['href']:
                url = a['href']
                l = [m.start() for m in re.finditer(r"https",url)]
                url = url[l[-1]:]
                break
    if len(url)>0:
        driver.get(url)
        soup = BeautifulSoup(driver.page_source, features="html.parser")
        text = soup.find_all(text=True)
        output = ''
        whitelist = 'noscript'
        for t in text:
            if t.parent.name == whitelist:
                output += '{} '.format(t)

        start = output.find("<div>") + 6
        end = output.find("</div>")
        output = output[start:end]
        if len(output)==0:
            print(f'url {isbn} has no description')
        return output

def grab_from_fnac(url, isbn, driver):
    search_query = 'site:fnac.pt/ AND ' + str(isbn)
    driver.get(url)
    try:
        search_query = driver.find_element_by_name('q').send_keys(search_query)
    except NoSuchElementException:
        pass
    time.sleep(0.5)
    try:
        driver.find_element_by_name('q').send_keys(Keys.RETURN)
    except NoSuchElementException:
        pass
    time.sleep(3)
    soup = BeautifulSoup(driver.page_source, features="html.parser")
    try:
        cites = driver.find_elements_by_tag_name('cite')
    except NoSuchElementException:
        pass
    output = ''
    for cite in cites:
        if len(cite.text)>0:
           index = cite.text.find("› ")
           output = cite.text[index+2:]
           break
    url = ''
    for a in soup.find_all('a'):
        if 'href' in a.attrs:
            if output[:output.find('...')] in a['href']:
                url = a['href']
                l = [m.start() for m in re.finditer(r"https",url)]
                url = url[l[-1]:]
                break
    if len(url)>0:
        driver.get(url)
        soup = BeautifulSoup(driver.page_source, features="html.parser")
        data = json.loads(soup.find('script', type='application/ld+json').text)
        if len(data['description'])==0:
            print(f'url {isbn} has no description')
        return data['description']

def add_to_postgres(json):
    print("trying to connect to db ...")
    c, conn = create_connection_postgres()
    print("started commiting to db .")
    for isbn, description in json.items():
        try:
            c.execute(
                'SELECT description FROM core_livre WHERE isbn=%s', isbn)
            if c.fetchone() is None:
                c.execute("UPDATE core_livre SET description='%s' WHERE isbn='%s' ", (description, isbn))
                print('added comment:', description)
                conn.commit()
        except psycopg2.IntegrityError:
            conn.rollback()
        except (Exception, psycopg2.Error) as error:
            print(error)
    if(conn):
        c.close()
        conn.close()
        print("PostgreSQL connection is closed")


def main():
    url = 'https://www.google.pt/'
    driver = make_webdriver()
    _json = dict()
    description = ''
    for isbn in isbn_list:
        description = grab_from_fnac(url, str(isbn), driver) 
        if len(description) == 0:
            description = grab_from_amazon(url, str(isbn), driver)
        _json[isbn] = description
        print(isbn, description[:3])

    add_to_postgres(_json)


if __name__ == '__main__':
    main()
